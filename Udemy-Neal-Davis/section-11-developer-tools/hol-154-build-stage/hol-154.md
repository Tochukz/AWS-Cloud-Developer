# Add Build Stage to Pipeline - HOL-154

### Description

### Operation

**Before deployment**

1. Package the code  
   Package the application code and upload to S3 bucket for the BeanStalk Application.

```bash
$ bash ./deploy-express.sh
```

**Deployment**

Lint the templates

```bash
$ cfn-lint BeanstalkApp
$ cfn-lint Pipeline.yaml
```

1. Deploy the `BeanstalkApp` stacks

```bash
$ aws cloudformation deploy --stack-name BeanstalkApp --template-file BeanstalkApp.yaml --capabilities CAPABILITY_NAMED_IAM
```

2. Deploy the `Pipeline` stack

```bash
$ aws cloudformation deploy --stack-name Pipeline --template-file Pipeline.yaml --capabilities CAPABILITY_NAMED_IAM --parameter-overrides file://secret-parameters.json
```

**After deployment**

1. Get the `EnvironmentURL` from the `BeanstalkApp` stack outputs

```bash
$ aws cloudformation describe-stacks --stack-name BeanstalkApp --query "Stacks[0].Outputs" --no-cli-pager
```

Use the `EnvironmentURL` to test the Beanstalk application over a Browser.

2. Make sure the `scripts.start = "node dist/main"` is in your package.json in your `nest-app`
3. Deploy the nest-app

```bash
$ ./deploy-nest.sh
```

4. Veryify that the content have changed by visiting the application on your browser using the `EnvironmentURL`

**Testing**

1. Go to the CodePipeline Console to take, select the Pipeline
2. You can manually trigger a release by clicking on the _Release Change_ button.
3. If you push new code to the master branch of the GitHub repo configured for the Pipeline, you will see an automatic release go into effect.

**Cleanup**
To delete the stacks

```bash
$ aws cloudformation delete-stack --stack-name Pipeline
$ aws cloudformation delete-stack --stack-name BeanstalkApp
```
