# Create Custom Metric and Alarm - HOL-180

### Description

Create a Custom Metric for Memory Usage in an EC2 instance.

### Operation

**Before deployment**

**Deployment**

Lint the templates

```bash
$ cfn-lint CustomMetric
```

Deploy the stack

```bash
$ aws cloudformation deploy --stack-name CustomMetric --template-file CustomMetric.yaml --capabilities CAPABILITY_NAMED_IAM --parameter-overrides NotificationEmail=email@company.com
```

**After deployment**

1. Get the `PublicIp` and `InstanceId` from the stack outputs

```bash
$ aws cloudformation describe-stacks --stack-name CustomMetric --query "Stacks[0].Outputs" --no-cli-pager
```

2. Copy the `mem-usage.sh` script to the EC2 instance

```bash
$ scp -i key-file.pem mem-usage.sh ec2-user@<public-ip>:~/mem-usage.sh
```

3. SSH into the EC2 instance

```bash
$ ssh -i key-file.pem ec2-user@<public-ip>
```

4. Run crontab

```bash
$ crontab -e
$ * * * * * /home/ec2-user/mem-usage.sh
```

4. Save and exit

```bash
$ :wq
```

5. Run the stress utility to generate load

```bash
$ stress-ng --vm 15 --vm-bytes 80% --vm-method all --verify -t 60m -v
```

**Testing**

Go to the CloudWatch Console > Metrics > All metrics.  
Look for the custom namespace `Custom/Memory` and the metric `MemUsage`. You should see the memory usage data being reported.

**Cleanup**  
To delete the stack

```bash
$ aws cloudformation delete-stack --stack-name CustomMetric
```
